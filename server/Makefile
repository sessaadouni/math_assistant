# Makefile pour Math RAG Assistant v3.1
# Usage: make <commande>

.PHONY: help install cli gui server check rebuild clean test format

# Couleurs pour l'affichage
BOLD := \033[1m
GREEN := \033[32m
CYAN := \033[36m
YELLOW := \033[33m
RESET := \033[0m

# Configuration
PYTHON := python3
UV := uv
PORT := 8000
HOST := 0.0.0.0

help: ## Affiche cette aide
	@echo "$(BOLD)$(CYAN)Math RAG Assistant v3.1$(RESET)"
	@echo ""
	@echo "$(BOLD)Commandes disponibles:$(RESET)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  $(CYAN)%-15s$(RESET) %s\n", $$1, $$2}'

install: ## Installe les d√©pendances
	@echo "$(BOLD)$(GREEN)üì¶ Installation des d√©pendances...$(RESET)"
	@if command -v $(UV) > /dev/null; then \
		$(UV) sync; \
	else \
		$(PYTHON) -m pip install -e .; \
	fi
	@echo "$(GREEN)‚úÖ Installation termin√©e$(RESET)"

install-dev: ## Installe les d√©pendances de d√©veloppement
	@echo "$(BOLD)$(GREEN)üì¶ Installation dev...$(RESET)"
	@$(PYTHON) -m pip install -e ".[dev]"
	@echo "$(GREEN)‚úÖ Installation dev termin√©e$(RESET)"

cli: ## Lance l'interface CLI
	@echo "$(BOLD)$(CYAN)üñ•Ô∏è  Lancement du CLI...$(RESET)"
	@$(PYTHON) scripts/run_cli.py

gui: ## Lance l'interface GUI
	@echo "$(BOLD)$(CYAN)üé® Lancement du GUI...$(RESET)"
	@$(PYTHON) scripts/run_gui.py

server: ## Lance le serveur FastAPI
	@echo "$(BOLD)$(CYAN)üöÄ Lancement du serveur...$(RESET)"
	@$(PYTHON) -m uvicorn server:app --host $(HOST) --port $(PORT) --reload

server-prod: ## Lance le serveur en mode production
	@echo "$(BOLD)$(CYAN)üöÄ Lancement du serveur (production)...$(RESET)"
	@$(PYTHON) -m uvicorn server:app --host $(HOST) --port $(PORT) --workers 4

check: ## V√©rifie l'√©tat du syst√®me RAG
	@echo "$(BOLD)$(CYAN)üîç V√©rification du syst√®me...$(RESET)"
	@$(PYTHON) scripts/rebuild_db.py --check-only

rebuild: ## Reconstruit la base vectorielle
	@echo "$(BOLD)$(YELLOW)üî® Reconstruction de la base...$(RESET)"
	@$(PYTHON) scripts/rebuild_db.py --force

rebuild-interactive: ## Reconstruit la base (avec confirmation)
	@echo "$(BOLD)$(YELLOW)üî® Reconstruction interactive...$(RESET)"
	@$(PYTHON) scripts/rebuild_db.py

clean: ## Nettoie les fichiers temporaires
	@echo "$(BOLD)$(YELLOW)üßπ Nettoyage...$(RESET)"
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type f -name "*.pyo" -delete 2>/dev/null || true
	@find . -type f -name ".coverage" -delete 2>/dev/null || true
	@find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	@echo "$(GREEN)‚úÖ Nettoyage termin√©$(RESET)"

clean-db: ## Supprime la base vectorielle
	@echo "$(BOLD)$(YELLOW)‚ö†Ô∏è  Suppression de la base vectorielle...$(RESET)"
	@read -p "√ätes-vous s√ªr ? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@rm -rf db/chroma_db_math_v3_1
	@echo "$(GREEN)‚úÖ Base supprim√©e$(RESET)"

clean-all: clean clean-db ## Nettoyage complet (fichiers + DB)
	@echo "$(GREEN)‚úÖ Nettoyage complet termin√©$(RESET)"

test: ## Lance les tests
	@echo "$(BOLD)$(CYAN)üß™ Lancement des tests...$(RESET)"
	@$(PYTHON) -m pytest tests/ -v

test-cov: ## Lance les tests avec coverage
	@echo "$(BOLD)$(CYAN)üß™ Tests avec coverage...$(RESET)"
	@$(PYTHON) -m pytest tests/ --cov=src --cov-report=html --cov-report=term

format: ## Formate le code (black + isort)
	@echo "$(BOLD)$(CYAN)üé® Formatage du code...$(RESET)"
	@$(PYTHON) -m black src/ scripts/
	@$(PYTHON) -m isort src/ scripts/
	@echo "$(GREEN)‚úÖ Formatage termin√©$(RESET)"

lint: ## V√©rifie le code (flake8 + mypy)
	@echo "$(BOLD)$(CYAN)üîç V√©rification du code...$(RESET)"
	@$(PYTHON) -m flake8 src/ scripts/
	@$(PYTHON) -m mypy src/ scripts/

docs: ## G√©n√®re la documentation
	@echo "$(BOLD)$(CYAN)üìö G√©n√©ration de la documentation...$(RESET)"
	@cd docs && make html
	@echo "$(GREEN)‚úÖ Documentation g√©n√©r√©e dans docs/_build/html/$(RESET)"

env: ## Cr√©e un fichier .env depuis .env.example
	@if [ ! -f .env ]; then \
		echo "$(BOLD)$(CYAN)üìù Cr√©ation du fichier .env...$(RESET)"; \
		cp .env.example .env; \
		echo "$(GREEN)‚úÖ Fichier .env cr√©√©. N'oubliez pas de le personnaliser !$(RESET)"; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  Le fichier .env existe d√©j√†$(RESET)"; \
	fi

status: ## Affiche le statut du projet
	@echo "$(BOLD)$(CYAN)üìä Statut du projet$(RESET)"
	@echo ""
	@echo "$(BOLD)Configuration:$(RESET)"
	@if [ -f .env ]; then \
		echo "  ‚úÖ .env pr√©sent"; \
	else \
		echo "  ‚ùå .env manquant (lancez: make env)"; \
	fi
	@echo ""
	@echo "$(BOLD)Base de donn√©es:$(RESET)"
	@if [ -d db/chroma_db_math_v3_1 ]; then \
		echo "  ‚úÖ Base vectorielle pr√©sente"; \
		@du -sh db/chroma_db_math_v3_1 | awk '{print "  üìä Taille: " $$1}'; \
	else \
		echo "  ‚ùå Base vectorielle manquante (lancez: make rebuild)"; \
	fi
	@echo ""
	@echo "$(BOLD)PDF:$(RESET)"
	@if [ -f model/livre_2011.pdf ]; then \
		echo "  ‚úÖ PDF pr√©sent"; \
		@du -sh model/livre_2011.pdf | awk '{print "  üìä Taille: " $$1}'; \
	else \
		echo "  ‚ùå PDF manquant"; \
	fi

logs: ## Affiche les derniers logs
	@echo "$(BOLD)$(CYAN)üìã Derniers logs:$(RESET)"
	@if [ -d logs ]; then \
		find logs -name "*.jsonl" -type f -exec ls -lh {} \; | tail -10; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  Aucun log trouv√©$(RESET)"; \
	fi

logs-clean: ## Nettoie les anciens logs
	@echo "$(BOLD)$(YELLOW)üßπ Nettoyage des logs...$(RESET)"
	@find logs -name "*.jsonl" -type f -mtime +30 -delete 2>/dev/null || true
	@echo "$(GREEN)‚úÖ Logs nettoy√©s (>30 jours)$(RESET)"

shell: ## Lance un shell Python avec imports
	@echo "$(BOLD)$(CYAN)üêç Shell Python interactif$(RESET)"
	@$(PYTHON) -i -c "\
from src.core.rag_engine import get_engine; \
from src.assistant.assistant import get_assistant; \
from src.core.config import rag_config; \
engine = get_engine(); \
assistant = get_assistant(); \
print('‚úÖ Imports charg√©s: engine, assistant, rag_config')"

watch-logs: ## Surveille les logs en temps r√©el
	@echo "$(BOLD)$(CYAN)üëÅÔ∏è  Surveillance des logs (Ctrl+C pour quitter)$(RESET)"
	@tail -f logs/*/*.jsonl 2>/dev/null || echo "$(YELLOW)‚ö†Ô∏è  Aucun log actif$(RESET)"

# Aliases
c: cli ## Alias pour cli
g: gui ## Alias pour gui
s: server ## Alias pour server
h: help ## Alias pour help